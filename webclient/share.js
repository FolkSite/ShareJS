(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m=[].slice,g=function(e,t){return function(){return e.apply(t,arguments)}};window.sharejs=u={version:"0.5.0-pre"},l=function(e){return setTimeout(e,0)},n=function(){function e(){}return e.prototype.on=function(e,t){var n;return this._events||(this._events={}),(n=this._events)[e]||(n[e]=[]),this._events[e].push(t),this},e.prototype.removeListener=function(e,t){var n,r,i,s=this;this._events||(this._events={}),r=(i=this._events)[e]||(i[e]=[]),n=0;while(n<r.length)r[n]===t&&(r[n]=void 0),n++;return l(function(){var t;return s._events[e]=function(){var n,r,i=this._events[e],s=[];for(n=0,r=i.length;n<r;n++)t=i[n],t&&s.push(t);return s}.call(s)}),this},e.prototype.emit=function(){var e,t,n,r,i,s=arguments[0],o=2<=arguments.length?m.call(arguments,1):[];if((r=this._events)!=null?!r[s]:!void 0)return this;i=this._events[s];for(t=0,n=i.length;t<n;t++)e=i[t],e&&e.apply(this,o);return this},e}(),n.mixin=function(e){var t=e.prototype||e;return t.on=n.prototype.on,t.removeListener=n.prototype.removeListener,t.emit=n.prototype.emit,e},u._bt=i=function(e,t,n,r){var i,s=function(e,n,r,i){return t(r,e,n,"left"),t(i,n,e,"right")};return e.transformX=e.transformX=i=function(e,t){var o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T;n(e),n(t),l=[];for(v=0,b=t.length;v<b;v++){d=t[v],f=[],o=0;while(o<e.length){c=[],s(e[o],d,f,c),o++;if(c.length!==1){if(c.length===0){x=e.slice(o);for(m=0,w=x.length;m<w;m++)u=x[m],r(f,u);d=null;break}T=i(e.slice(o),c),a=T[0],p=T[1];for(g=0,E=a.length;g<E;g++)u=a[g],r(f,u);for(y=0,S=p.length;y<S;y++)h=p[y],r(l,h);d=null;break}d=c[0]}d!=null&&r(l,d),e=f}return[e,l]},e.transform=e.transform=function(e,n,r){var s,o,u,a,f;if(r!=="left"&&r!=="right")throw new Error("type must be 'left' or 'right'");return n.length===0?e:e.length===1&&n.length===1?t([],e[0],n[0],r):r==="left"?(a=i(e,n),s=a[0],u=a[1],s):(f=i(n,e),u=f[0],o=f[1],o)}},h={},h.name="text",h.create=h.create=function(){return""},c=function(e,t,n){return e.slice(0,t)+n+e.slice(t)},s=function(e){var t,n;if(typeof e.p!="number")throw new Error("component missing position field");n=typeof e.i,t=typeof e.d;if(!(n==="string"^t==="string"))throw new Error("component needs an i or d field");if(!(e.p>=0))throw new Error("position cannot be negative")},o=function(e){var t,n,r;for(n=0,r=e.length;n<r;n++)t=e[n],s(t);return!0},h.apply=function(e,t){var n,r,i,s;o(t);for(i=0,s=t.length;i<s;i++){n=t[i];if(n.i!=null)e=c(e,n.p,n.i);else{r=e.slice(n.p,n.p+n.d.length);if(n.d!==r)throw new Error("Delete component '"+n.d+"' does not match deleted text '"+r+"'");e=e.slice(0,n.p)+e.slice(n.p+n.d.length)}}return e},h._append=r=function(e,t){var n,r,i;if(t.i===""||t.d==="")return;return e.length===0?e.push(t):(n=e[e.length-1],n.i!=null&&t.i!=null&&n.p<=(r=t.p)&&r<=n.p+n.i.length?e[e.length-1]={i:c(n.i,t.p-n.p,t.i),p:n.p}:n.d!=null&&t.d!=null&&t.p<=(i=n.p)&&i<=t.p+t.d.length?e[e.length-1]={d:c(t.d,n.p-t.p,n.d),p:t.p}:e.push(t))},h.compose=function(e,t){var n,i,s,u;o(e),o(t),i=e.slice();for(s=0,u=t.length;s<u;s++)n=t[s],r(i,n);return i},h.compress=function(e){return h.compose([],e)},h.normalize=function(e){var t,n,i,s,o=[];if(e.i!=null||e.p!=null)e=[e];for(n=0,i=e.length;n<i;n++)t=e[n],(s=t.p)==null&&(t.p=0),r(o,t);return o},d=function(e,t,n){return t.i!=null?t.p<e||t.p===e&&n?e+t.i.length:e:e<=t.p?e:e<=t.p+t.d.length?t.p:e-t.d.length},h.transformCursor=function(e,t,n){var r,i,s;for(i=0,s=t.length;i<s;i++)r=t[i],e=d(e,r,n);return e},h._tc=p=function(e,t,n,i){var s,u,a,f,l,c;o([t]),o([n]);if(t.i!=null)r(e,{i:t.i,p:d(t.p,n,i==="right")});else if(n.i!=null)c=t.d,t.p<n.p&&(r(e,{d:c.slice(0,n.p-t.p),p:t.p}),c=c.slice(n.p-t.p)),c!==""&&r(e,{d:c,p:t.p+n.i.length});else if(t.p>=n.p+n.d.length)r(e,{d:t.d,p:t.p-n.d.length});else if(t.p+t.d.length<=n.p)r(e,t);else{f={d:"",p:t.p},t.p<n.p&&(f.d=t.d.slice(0,n.p-t.p)),t.p+t.d.length>n.p+n.d.length&&(f.d+=t.d.slice(n.p+n.d.length-t.p)),a=Math.max(t.p,n.p),u=Math.min(t.p+t.d.length,n.p+n.d.length),s=t.d.slice(a-t.p,u-t.p),l=n.d.slice(a-n.p,u-n.p);if(s!==l)throw new Error("Delete ops delete different text in the same region of the document");f.d!==""&&(f.p=d(f.p,n),r(e,f))}return e},a=function(e){return e.i!=null?{d:e.i,p:e.p}:{i:e.d,p:e.p}},h.invert=function(e){var t,n,r,i=e.slice().reverse(),s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(a(t));return s},u.types||(u.types={}),i(h,p,o,r),u.types.text=h,h.api={provides:{text:!0},getLength:function(){return this.snapshot.length},getText:function(){return this.snapshot},insert:function(e,t,n){var r=[{p:e,i:t}];return this.submitOp(r,n),r},del:function(e,t,n){var r=[{p:e,d:this.snapshot.slice(e,e+t)}];return this.submitOp(r,n),r},_register:function(){return this.on("remoteop",function(e){var t,n,r,i=[];for(n=0,r=e.length;n<r;n++)t=e[n],t.i!==void 0?i.push(this.emit("insert",t.p,t.i)):i.push(this.emit("delete",t.p,t.d));return i})}},t=function(e,t,n,r,i){var s,o,u,a,f,l,c,h,p,d,v=this;this.name=t,this.version=n,this.type=r,this.snapshot=i;if(this.type.compose==null)throw new Error("Handling types without compose() defined is not currently implemented");o=null,s=[],l=null,f=[],c={},p=this.type.transformX||function(e,t){var n=v.type.transform(e,t,"left"),r=v.type.transform(t,e,"right");return[n,r]},a=function(e,t){var n=v.snapshot;v.snapshot=v.type.apply(v.snapshot,e),v.emit("change",e,n);if(t)return v.emit("remoteop",e,n)},this.flush=function(){if(o===null&&l!==null)return o=l,s=f,l=null,f=[],e.send({doc:v.name,op:o,v:v.version},function(e,t){var n,i,u,f,h,d,m,g=o;o=null;if(e){if(!r.invert)throw new Error("Op apply failed ("+t.error+") and the OT type does not define an invert function.");i=v.type.invert(g),l&&(m=p(l,i),l=m[0],i=m[1]),a(i,!0);for(u=0,h=s.length;u<h;u++)n=s[u],n(e)}else{if(t.v!==v.version)throw new Error("Invalid version from server");c[v.version]=g,v.version++;for(f=0,d=s.length;f<d;f++)n=s[f],n(null,g)}return v.flush()})},this._onOpReceived=function(e){var t,n,r,i;if(e.v<this.version)return;if(e.doc!==this.name)throw new Error("Expected docName '"+this.name+"' but got "+e.doc);if(e.v!==this.version)throw new Error("Expected version "+this.version+" but got "+e.v);return n=e.op,c[this.version]=n,t=n,o!==null&&(r=p(o,t),o=r[0],t=r[1]),l!==null&&(i=p(l,t),l=i[0],t=i[1]),this.version++,a(t,!0)},this.submitOp=function(e,t){return this.type.normalize!=null&&(e=this.type.normalize(e)),this.snapshot=this.type.apply(this.snapshot,e),l!==null?l=this.type.compose(l,e):l=e,t&&f.push(t),this.emit("change",e),setTimeout(this.flush,0)},this.close=function(t){var n=this;return e.socket===null?typeof t=="function"?t():void 0:(e.send({doc:this.name,open:!1},function(){typeof t=="function"&&t(),n.emit("closed")}),this.emit("closing"))};if(this.type.api){d=this.type.api;for(u in d)h=d[u],this[u]=h;typeof this._register=="function"&&this._register()}else this.provides={};return this},n.mixin(t),u.Doc=t;if(typeof v=="undefined"||v===null)v=u.types;if(!window.io)throw new Error("Must load socket.io before this library");f=window.io,e=function(){function e(e){var t;this.onMessage=g(this.onMessage,this),this.connected=g(this.connected,this),this.disconnected=g(this.disconnected,this),t=this,this.docs={},this.handlers={},this.state="connecting",this.socket=f.connect(e,{"force new connection":!0}),this.socket.on("connect",this.connected),this.socket.on("disconnect",this.disconnected),this.socket.on("message",this.onMessage),this.socket.on("connect_failed",function(e){var n,r,i,s,o,u,a;e==="unauthorized"&&(e="forbidden"),t.socket=null,t.emit("connect failed",e),u=t.handlers,a=[];for(i in u)s=u[i],a.push(function(){var t=[];for(o in s)r=s[o],t.push(function(){var t,i,s=[];for(t=0,i=r.length;t<i;t++)n=r[t],s.push(n(e));return s}());return t}());return a})}return e.prototype.disconnected=function(){return this.emit("disconnect"),this.socket=null},e.prototype.connected=function(){return this.emit("connect")},e.prototype.send=function(e,t){var n,r,i,s,o;if(this.socket===null)throw new Error("Cannot send message "+JSON.stringify(e)+" to a closed connection");i=e.doc,i===this.lastSentDoc?delete e.doc:this.lastSentDoc=i,this.socket.json.send(e);if(t)return s=e.open===!0?"open":e.open===!1?"close":e.create?"create":e.snapshot===null?"snapshot":e.op?"op response":void 0,r=(o=this.handlers)[i]||(o[i]={}),n=r[s]||(r[s]=[]),n.push(t)},e.prototype.onMessage=function(e){var t,n,r,i,s,o,u,a=e.doc;a!==void 0?this.lastReceivedDoc=a:e.doc=a=this.lastReceivedDoc,this.emit("message",e),i=e.open===!0||e.open===!1&&e.error?"open":e.open===!1?"close":e.snapshot!==void 0?"snapshot":e.create?"create":e.op?"op":e.v!==void 0?"op response":void 0,n=(u=this.handlers[a])!=null?u[i]:void 0;if(n){delete this.handlers[a][i];for(s=0,o=n.length;s<o;s++)t=n[s],t(e.error,e)}if(i==="op"){r=this.docs[a];if(r)return r._onOpReceived(e)}},e.prototype.makeDoc=function(e){var n,r,i=this,s=e.doc;if(this.docs[s])throw new Error("Doc "+s+" already open");return r=e.type,typeof r=="string"&&(r=v[r]),n=new t(this,s,e.v,r,e.snapshot),n.created=!!e.create,this.docs[s]=n,n.on("closing",function(){return delete i.docs[s]}),n},e.prototype.openExisting=function(e,t){var n=this;if(this.socket===null){t("connection closed");return}return this.docs[e]!=null?this.docs[e]:this.send({doc:e,open:!0,snapshot:null},function(e,r){return e?t(e):t(null,n.makeDoc(r))})},e.prototype.open=function(e,t,n){var r,i=this;if(this.socket===null){n("connection closed");return}typeof t=="function"&&(n=t,t="text"),n||(n=function(){}),typeof t=="string"&&(t=v[t]);if(!t)throw new Error("OT code for document type missing");if(e!=null&&this.docs[e]!=null){r=this.docs[e],r.type===t?n(null,r):n("Type mismatch",r);return}return this.send({doc:e,open:!0,create:!0,snapshot:null,type:t.name},function(e,r){return e?n(e):(r.snapshot===void 0&&(r.snapshot=t.create()),r.type=t,n(null,i.makeDoc(r)))})},e.prototype.create=function(e,t){return open(null,e,t)},e.prototype.disconnect=function(){if(this.socket)return this.emit("disconnecting"),this.socket.disconnect(),this.socket=null},e}(),n.mixin(e),u.Connection=e,u.open=function(){var t={},n=function(n){var r,i,s;return s=window.location,n==null&&(n=""+s.protocol+"//"+s.hostname+"/sjs"),t[n]||(r=new e(n),r.numDocs=0,i=function(){return delete t[n]},r.on("disconnecting",i),r.on("connect failed",i),t[n]=r),t[n]};return function(e,t,r,i){var s;return typeof r=="function"&&(i=r,r=null),s=n(r),s.numDocs++,s.open(e,t,function(e,t){return e?(s.numDocs--,s.numDocs===0&&s.disconnect(),i(e)):(t.on("closed",function(){s.numDocs--;if(s.numDocs===0)return s.disconnect()}),i(null,t))}),s.on("connect failed")}}()}).call(this)